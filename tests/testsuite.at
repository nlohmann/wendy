AT_INIT

m4_define(AT_CHECK_LOLA, [AT_CHECK([if test "LOLA" == ""; then exit 77; fi])])
AT_TESTED(versions.sh)

############################################################################
AT_BANNER([Standard Options])
############################################################################

AT_SETUP([Help output])
AT_CHECK([WENDY --help],0,ignore)
AT_KEYWORDS(basic)
AT_CLEANUP

AT_SETUP([Version output])
AT_CHECK([WENDY --version],0,ignore)
AT_KEYWORDS(basic)
AT_CLEANUP


############################################################################
AT_BANNER([Errors])
############################################################################

AT_SETUP([Input file not found])
AT_CHECK([WENDY foo.owfn --lola=],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#01\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP

AT_SETUP([Syntax error])
AT_CHECK([cp TESTFILES/error02.* .])
AT_CHECK([WENDY error02.owfn --lola=],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#02\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP

AT_SETUP([Un-normal input net])
AT_CHECK([cp TESTFILES/error03.* .])
AT_CHECK([WENDY error03.owfn --lola=],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#03\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP

AT_SETUP([Multiple file input])
AT_CHECK([cp TESTFILES/error04* .])
AT_CHECK([WENDY error04-1.owfn error04-2.owfn --lola=],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#04\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP

AT_SETUP([Error building the reachability graph])
AT_CHECK([cp TESTFILES/error06.* .])
AT_CHECK([WENDY error06.owfn --lola=foo],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#06\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP

AT_SETUP([Invalid command line parameter])
AT_CHECK([WENDY --foo],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#07\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP

AT_SETUP([Negative report frequency])
AT_CHECK([WENDY --reportFrequency=-10],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#08\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP

AT_SETUP([Message bound violation])
AT_CHECK([WENDY --messagebound=400 --lola=],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#09\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP

AT_SETUP([Synchronous channels and 2-bit annotations])
AT_CHECK([cp TESTFILES/error10.* .])
AT_CHECK([WENDY error10.owfn --lola= --formula=2bits --og],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#10\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP

AT_SETUP([Simultaneous OG and SA output])
AT_CHECK([WENDY --og --sa],1,ignore,stderr)
AT_CHECK([GREP -q "aborting \[[#12\]]" stderr])
AT_KEYWORDS(error)
AT_CLEANUP


############################################################################
AT_BANNER([Regression Tests])
############################################################################

AT_SETUP([Bug 1])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug1.* .])
AT_CHECK([WENDY bug1.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence bug1.og bug1.fiona.og],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 2])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug2.* .])
AT_CHECK([WENDY bug2.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence bug2.og bug2.fiona.og],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 3])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug3.* .])
AT_CHECK([WENDY bug3.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence bug3.og bug3.fiona.og],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 4])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug4.* .])
AT_CHECK([WENDY bug4.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence bug4.og bug4.fiona.og],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 5])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug5.* .])
AT_CHECK([WENDY bug5.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence bug5.og bug5.fiona.og],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 6])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug6.* .])
AT_CHECK([WENDY bug6.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence bug6.og bug6.fiona.og],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 7])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug7.* .])
AT_CHECK([WENDY bug7.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence bug7.og bug7.fiona.og],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 8])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug8.* .])
AT_CHECK([WENDY bug8.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence bug8.og bug8.fiona.og],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 9])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug9.* .])
AT_CHECK([WENDY bug9.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence bug9.og bug9.fiona.og],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 13651 (https://gna.org/bugs/?13651)])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug13651.owfn .])
AT_CHECK([WENDY bug13651.owfn --verbose],0,ignore,ignore)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 13718 (https://gna.org/bugs/?13718)])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug13718.owfn .])
AT_CHECK([WENDY bug13718.owfn --verbose --og --formula=2],0,ignore,ignore)
AT_CHECK([GREP -c ":: S" bug13718.og],0,[4
])
AT_CHECK([GREP -c ":: F" bug13718.og],0,[4
])
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 13903 (https://gna.org/bugs/?13903)])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/myCoffee.owfn .])
AT_CHECK([WENDY myCoffee.owfn --verbose --og --tmpfile=foo-XXXXXX],0,ignore,ignore)
AT_CHECK([test -f foo-*.lola])
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 13994 (https://gna.org/bugs/?13994)])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug13994-1.owfn .])
AT_CHECK([WENDY bug13994-1.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "wendy: net is controllable: NO" stderr],0)
AT_CHECK([cp TESTFILES/bug13994-2.owfn .])
AT_CHECK([WENDY bug13994-2.owfn --verbose],0,ignore,stderr)
AT_CHECK([GREP -q "wendy: net is controllable: NO" stderr],0)
AT_KEYWORDS(bug)
AT_CLEANUP

AT_SETUP([Bug 14025 (https://gna.org/bugs/?14025)])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/bug14025.owfn .])
AT_CHECK([WENDY bug14025.owfn --verbose --dot --og],0,ignore,ignore)
AT_CHECK([GREP -c "\->" bug14025.dot],0,[5
])
AT_KEYWORDS(bug)
AT_CLEANUP


############################################################################
AT_BANNER([Operating Guidelines])
############################################################################

AT_SETUP([Coffee Automaton])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/myCoffee.* .])
AT_CHECK([WENDY myCoffee.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence myCoffee.og myCoffee.fiona.og],0,ignore,ignore)
AT_KEYWORDS(og)
AT_CLEANUP

AT_SETUP([Dining Philosophers])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/phcontrol3.unf.* .])
AT_CHECK([WENDY phcontrol3.unf.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence phcontrol3.unf.og phcontrol3.unf.fiona.og],0,ignore,ignore)
AT_KEYWORDS(og)
AT_CLEANUP

AT_SETUP([Purchase Order Process])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/PO.* .])
AT_CHECK([WENDY PO.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence PO.og PO.fiona.og],0,ignore,ignore)
AT_KEYWORDS(og)
AT_CLEANUP

AT_SETUP([Sequence])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/sequence10.* .])
AT_CHECK([WENDY sequence10.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence sequence10.og sequence10.fiona.og],0,ignore,ignore)
AT_KEYWORDS(og)
AT_CLEANUP

AT_SETUP([SMTP Protocol])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/smtp3.* .])
AT_CHECK([WENDY smtp3.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence smtp3.og smtp3.fiona.og],0,ignore,ignore)
AT_KEYWORDS(og)
AT_CLEANUP

AT_SETUP([Travel Service])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/T2.* .])
AT_CHECK([WENDY T2.owfn --fionaFormat --og --verbose --messagebound=2],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence T2.og T2.fiona.og],0,ignore,ignore)
AT_KEYWORDS(og)
AT_CLEANUP

AT_SETUP([ZEUS Seller Service])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/zeus.* .])
AT_CHECK([WENDY zeus.owfn --fionaFormat --og --verbose],0,ignore,ignore)
AT_CHECK([FIONA -tequivalence zeus.og zeus.fiona.og],0,ignore,ignore)
AT_KEYWORDS(og)
AT_CLEANUP


############################################################################
AT_BANNER([Interaction Graph])
############################################################################

AT_SETUP([Reduction: none])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/PO.owfn .])
AT_CHECK([WENDY PO.owfn --sa --verbose],0,ignore,ignore)
AT_CHECK([GREP -q "168 nodes" PO.sa])
AT_CHECK([GREP -c "\->" PO.sa],0,[548
])
AT_KEYWORDS(ig)
AT_CLEANUP

AT_SETUP([Reduction: consider only waitstates])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/PO.owfn .])
AT_CHECK([WENDY PO.owfn --sa --verbose --waitstatesOnly],0,ignore,ignore)
AT_CHECK([GREP -q "137 nodes" PO.sa])
AT_CHECK([GREP -c "\->" PO.sa],0,[437
])
AT_KEYWORDS(ig)
AT_CLEANUP

AT_SETUP([Reduction: receive before send])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/PO.owfn .])
AT_CHECK([WENDY PO.owfn --sa --verbose --receiveBeforeSend],0,ignore,ignore)
AT_CHECK([GREP -q "168 nodes" PO.sa])
AT_CHECK([GREP -c "\->" PO.sa],0,[416
])
AT_KEYWORDS(ig)
AT_CLEANUP


############################################################################
AT_BANNER([Synchronous Communication])
############################################################################

AT_SETUP([Philosophers])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/phil5.owfn .])
AT_CHECK([WENDY phil5.owfn --og --verbose],0,ignore,ignore)
AT_CHECK([GREP -q "721 nodes" phil5.og])
AT_CHECK([GREP -c "\->" phil5.og],0,[7200
])
AT_KEYWORDS(synchronous)
AT_CLEANUP

AT_SETUP([Car Reservation])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/carreservation_with_engine.owfn .])
AT_CHECK([WENDY carreservation_with_engine.owfn --og --verbose],0,ignore,ignore)
AT_CHECK([GREP -q "309 nodes" carreservation_with_engine.og])
AT_CHECK([GREP -c "\->" carreservation_with_engine.og],0,[6510
])
AT_KEYWORDS(synchronous)
AT_CLEANUP

AT_SETUP([Test net])
AT_CHECK_LOLA
AT_CHECK([cp TESTFILES/test-sync.owfn .])
AT_CHECK([WENDY test-sync.owfn --og --verbose],0,ignore,ignore)
AT_CHECK([GREP -q "13 nodes" test-sync.og])
AT_CHECK([GREP -c "\->" test-sync.og],0,[154
])
AT_KEYWORDS(synchronous)
AT_CLEANUP
